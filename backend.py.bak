from flask import Flask, request, jsonify
from flask_cors import CORS
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime
import os

# Initialize Flask app
app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///shop-pro.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['JSON_SORT_KEYS'] = False

# Initialize database
db = SQLAlchemy(app)
CORS(app)

# ==================== DATABASE MODELS ====================

class Product(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(255), nullable=False)
    category = db.Column(db.String(100), nullable=False)
    description = db.Column(db.Text)
    priceType = db.Column(db.String(10), default='fixed')  # 'fixed' or 'range'
    price = db.Column(db.Float)
    priceMin = db.Column(db.Float)
    priceMax = db.Column(db.Float)
    email = db.Column(db.String(255))
    phone = db.Column(db.String(20))
    whatsapp = db.Column(db.String(20))
    contactMethods = db.Column(db.String(255))  # JSON string: 'email,phone,whatsapp'
    createdAt = db.Column(db.DateTime, default=datetime.utcnow)
    ratings = db.relationship('Rating', backref='product', lazy=True, cascade='all, delete-orphan')

    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'category': self.category,
            'description': self.description,
            'priceType': self.priceType,
            'price': self.price,
            'priceMin': self.priceMin,
            'priceMax': self.priceMax,
            'email': self.email,
            'phone': self.phone,
            'whatsapp': self.whatsapp,
            'contactMethods': self.contactMethods.split(',') if self.contactMethods else []
        }


class CartItem(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    userId = db.Column(db.String(255), default='guest')
    productId = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False)
    quantity = db.Column(db.Integer, default=1)
    addedAt = db.Column(db.DateTime, default=datetime.utcnow)
    product = db.relationship('Product')

    def to_dict(self):
        product = self.product.to_dict()
        product['quantity'] = self.quantity
        product['cartItemId'] = self.id
        return product


class Order(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    userId = db.Column(db.String(255), default='guest')
    items = db.relationship('OrderItem', backref='order', lazy=True, cascade='all, delete-orphan')
    total = db.Column(db.Float, nullable=False)
    status = db.Column(db.String(50), default='pending')  # pending, processing, shipped, delivered, cancelled
    createdAt = db.Column(db.DateTime, default=datetime.utcnow)
    discountApplied = db.Column(db.String(100))

    def to_dict(self):
        return {
            'id': self.id,
            'items': [item.to_dict() for item in self.items],
            'total': self.total,
            'status': self.status,
            'date': self.createdAt.strftime('%Y-%m-%d %H:%M:%S'),
            'discountApplied': self.discountApplied
        }


class OrderItem(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    orderId = db.Column(db.Integer, db.ForeignKey('order.id'), nullable=False)
    productId = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False)
    name = db.Column(db.String(255), nullable=False)
    quantity = db.Column(db.Integer, default=1)
    price = db.Column(db.Float)
    product = db.relationship('Product')

    def to_dict(self):
        return {
            'name': self.name,
            'quantity': self.quantity,
            'price': self.price
        }


class Rating(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    productId = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False)
    rating = db.Column(db.Integer, nullable=False)
    review = db.Column(db.Text)
    createdAt = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'rating': self.rating,
            'review': self.review,
            'date': self.createdAt.strftime('%Y-%m-%d')
        }


class Favorite(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    userId = db.Column(db.String(255), default='guest')
    productId = db.Column(db.Integer, db.ForeignKey('product.id'), nullable=False)
    addedAt = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {'id': self.id, 'productId': self.productId}


class UserProfile(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    userId = db.Column(db.String(255), unique=True, default='guest')
    name = db.Column(db.String(255))
    email = db.Column(db.String(255))
    phone = db.Column(db.String(20))
    address = db.Column(db.Text)
    darkMode = db.Column(db.Boolean, default=False)
    createdAt = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'userId': self.userId,
            'name': self.name,
            'email': self.email,
            'phone': self.phone,
            'address': self.address,
            'darkMode': self.darkMode
        }


# ==================== HELPER FUNCTIONS ====================

def init_sample_products():
    """Load sample products if database is empty"""
    if Product.query.first() is not None:
        return
    
    products = [
        Product(
            name='Wireless Headphones',
            category='electronics',
            description='High-quality wireless headphones with noise cancellation',
            priceType='fixed',
            price=79.99,
            email='seller1@example.com',
            phone='+23278335335',
            whatsapp='+23278335335',
            contactMethods='email,phone,whatsapp'
        ),
        Product(
            name='Running Shoes',
            category='sports',
            description='Comfortable running shoes for all terrains',
            priceType='fixed',
            price=89.99,
            email='seller2@example.com',
            whatsapp='+1-555-0102',
            contactMethods='email,whatsapp'
        ),
        Product(
            name='JavaScript Book',
            category='books',
            description='Learn JavaScript from basics to advanced',
            priceType='fixed',
            price=34.99,
            email='seller3@example.com',
            contactMethods='email'
        ),
        Product(
            name='Gaming Mouse',
            category='electronics',
            description='Professional gaming mouse with customizable buttons',
            priceType='fixed',
            price=49.99,
            email='seller4@example.com',
            phone='+1-555-0104',
            contactMethods='email,phone'
        ),
        Product(
            name='Cotton T-Shirt',
            category='clothing',
            description='Premium quality cotton t-shirt available in all sizes',
            priceType='range',
            priceMin=15.99,
            priceMax=24.99,
            email='seller5@example.com',
            whatsapp='+1-555-0105',
            contactMethods='email,whatsapp'
        )
    ]
    
    for product in products:
        db.session.add(product)
    db.session.commit()


# ==================== API ENDPOINTS - PRODUCTS ====================

@app.route('/api/products', methods=['GET'])
def get_products():
    products = Product.query.all()
    return jsonify([p.to_dict() for p in products])


@app.route('/api/products', methods=['POST'])
def add_product():
    data = request.json
    try:
        product = Product(
            name=data['name'],
            category=data['category'],
            description=data['description'],
            priceType=data['priceType'],
            price=data.get('price'),
            priceMin=data.get('priceMin'),
            priceMax=data.get('priceMax'),
            email=data.get('email'),
            phone=data.get('phone'),
            whatsapp=data.get('whatsapp'),
            contactMethods=','.join(data.get('contactMethods', []))
        )
        db.session.add(product)
        db.session.commit()
        return jsonify({'success': True, 'product': product.to_dict()}), 201
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/products/<int:product_id>', methods=['GET'])
def get_product(product_id):
    product = Product.query.get_or_404(product_id)
    return jsonify(product.to_dict())


@app.route('/api/products/<int:product_id>', methods=['PUT'])
def update_product(product_id):
    product = Product.query.get_or_404(product_id)
    data = request.json
    try:
        product.name = data.get('name', product.name)
        product.category = data.get('category', product.category)
        product.description = data.get('description', product.description)
        product.priceType = data.get('priceType', product.priceType)
        product.price = data.get('price', product.price)
        product.priceMin = data.get('priceMin', product.priceMin)
        product.priceMax = data.get('priceMax', product.priceMax)
        product.email = data.get('email', product.email)
        product.phone = data.get('phone', product.phone)
        product.whatsapp = data.get('whatsapp', product.whatsapp)
        if 'contactMethods' in data:
            product.contactMethods = ','.join(data['contactMethods'])
        db.session.commit()
        return jsonify({'success': True, 'product': product.to_dict()})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/products/<int:product_id>', methods=['DELETE'])
def delete_product(product_id):
    product = Product.query.get_or_404(product_id)
    try:
        db.session.delete(product)
        db.session.commit()
        return jsonify({'success': True, 'message': 'Product deleted'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


# ==================== API ENDPOINTS - CART ====================

@app.route('/api/cart', methods=['GET'])
def get_cart():
    user_id = request.args.get('userId', 'guest')
    items = CartItem.query.filter_by(userId=user_id).all()
    return jsonify([item.to_dict() for item in items])


@app.route('/api/cart', methods=['POST'])
def add_to_cart():
    data = request.json
    user_id = data.get('userId', 'guest')
    product_id = data['productId']
    
    try:
        # Check if item already in cart
        existing = CartItem.query.filter_by(userId=user_id, productId=product_id).first()
        if existing:
            existing.quantity += 1
        else:
            cart_item = CartItem(userId=user_id, productId=product_id, quantity=1)
            db.session.add(cart_item)
        
        db.session.commit()
        return jsonify({'success': True, 'message': 'Added to cart'}), 201
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/cart/<int:item_id>', methods=['PUT'])
def update_cart_item(item_id):
    item = CartItem.query.get_or_404(item_id)
    data = request.json
    try:
        item.quantity = max(1, data.get('quantity', item.quantity))
        db.session.commit()
        return jsonify({'success': True, 'item': item.to_dict()})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/cart/<int:item_id>', methods=['DELETE'])
def remove_from_cart(item_id):
    item = CartItem.query.get_or_404(item_id)
    try:
        db.session.delete(item)
        db.session.commit()
        return jsonify({'success': True, 'message': 'Removed from cart'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/cart', methods=['DELETE'])
def clear_cart():
    user_id = request.args.get('userId', 'guest')
    try:
        CartItem.query.filter_by(userId=user_id).delete()
        db.session.commit()
        return jsonify({'success': True, 'message': 'Cart cleared'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


# ==================== API ENDPOINTS - ORDERS ====================

@app.route('/api/orders', methods=['GET'])
def get_orders():
    user_id = request.args.get('userId', 'guest')
    orders = Order.query.filter_by(userId=user_id).all()
    return jsonify([o.to_dict() for o in orders])


@app.route('/api/orders', methods=['POST'])
def create_order():
    data = request.json
    user_id = data.get('userId', 'guest')
    
    try:
        # Get cart items
        cart_items = CartItem.query.filter_by(userId=user_id).all()
        if not cart_items:
            return jsonify({'success': False, 'error': 'Cart is empty'}), 400
        
        # Calculate total
        total = 0
        order_items = []
        for cart_item in cart_items:
            product = cart_item.product
            price = product.price if product.priceType == 'fixed' else (product.priceMin + product.priceMax) / 2
            item_total = price * cart_item.quantity
            total += item_total
            
            order_items.append({
                'productId': product.id,
                'name': product.name,
                'quantity': cart_item.quantity,
                'price': price
            })
        
        # Apply discount if exists
        discount = data.get('discountCode')
        discounts = {'SAVE10': 0.10, 'SAVE20': 0.20, 'WELCOME5': 0.05}
        if discount and discount in discounts:
            total *= (1 - discounts[discount])
        
        # Create order
        order = Order(userId=user_id, total=total, discountApplied=discount)
        db.session.add(order)
        db.session.flush()
        
        # Add order items
        for item_data in order_items:
            order_item = OrderItem(
                orderId=order.id,
                productId=item_data['productId'],
                name=item_data['name'],
                quantity=item_data['quantity'],
                price=item_data['price']
            )
            db.session.add(order_item)
        
        # Clear cart
        CartItem.query.filter_by(userId=user_id).delete()
        
        db.session.commit()
        return jsonify({'success': True, 'order': order.to_dict()}), 201
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/orders/<int:order_id>/status', methods=['PUT'])
def update_order_status(order_id):
    order = Order.query.get_or_404(order_id)
    data = request.json
    try:
        order.status = data.get('status', order.status)
        db.session.commit()
        return jsonify({'success': True, 'order': order.to_dict()})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


# ==================== API ENDPOINTS - RATINGS & REVIEWS ====================

@app.route('/api/ratings/<int:product_id>', methods=['GET'])
def get_ratings(product_id):
    ratings = Rating.query.filter_by(productId=product_id).all()
    return jsonify([r.to_dict() for r in ratings])


@app.route('/api/ratings', methods=['POST'])
def add_rating():
    data = request.json
    try:
        rating = Rating(
            productId=data['productId'],
            rating=data['rating'],
            review=data.get('review', '')
        )
        db.session.add(rating)
        db.session.commit()
        return jsonify({'success': True, 'rating': rating.to_dict()}), 201
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


# ==================== API ENDPOINTS - FAVORITES ====================

@app.route('/api/favorites', methods=['GET'])
def get_favorites():
    user_id = request.args.get('userId', 'guest')
    favorites = Favorite.query.filter_by(userId=user_id).all()
    return jsonify([f.to_dict() for f in favorites])


@app.route('/api/favorites', methods=['POST'])
def add_favorite():
    data = request.json
    user_id = data.get('userId', 'guest')
    product_id = data['productId']
    
    try:
        existing = Favorite.query.filter_by(userId=user_id, productId=product_id).first()
        if existing:
            db.session.delete(existing)
            message = 'Removed from favorites'
        else:
            favorite = Favorite(userId=user_id, productId=product_id)
            db.session.add(favorite)
            message = 'Added to favorites'
        
        db.session.commit()
        return jsonify({'success': True, 'message': message}), 201
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


@app.route('/api/favorites/<int:product_id>', methods=['GET'])
def is_favorite(product_id):
    user_id = request.args.get('userId', 'guest')
    favorite = Favorite.query.filter_by(userId=user_id, productId=product_id).first()
    return jsonify({'isFavorite': favorite is not None})


# ==================== API ENDPOINTS - USER PROFILE ====================

@app.route('/api/profile', methods=['GET'])
def get_profile():
    user_id = request.args.get('userId', 'guest')
    profile = UserProfile.query.filter_by(userId=user_id).first()
    if not profile:
        profile = UserProfile(userId=user_id)
        db.session.add(profile)
        db.session.commit()
    return jsonify(profile.to_dict())


@app.route('/api/profile', methods=['POST'])
def update_profile():
    data = request.json
    user_id = data.get('userId', 'guest')
    
    try:
        profile = UserProfile.query.filter_by(userId=user_id).first()
        if not profile:
            profile = UserProfile(userId=user_id)
        
        profile.name = data.get('name', profile.name)
        profile.email = data.get('email', profile.email)
        profile.phone = data.get('phone', profile.phone)
        profile.address = data.get('address', profile.address)
        profile.darkMode = data.get('darkMode', profile.darkMode)
        
        db.session.add(profile)
        db.session.commit()
        return jsonify({'success': True, 'profile': profile.to_dict()}), 201
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 400


# ==================== HEALTH CHECK ====================

@app.route('/api/health', methods=['GET'])
def health():
    return jsonify({'status': 'ok', 'message': 'Shop Pro API is running'})


# ==================== ERROR HANDLERS ====================

@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'Not found'}), 404


@app.errorhandler(500)
def server_error(error):
    return jsonify({'error': 'Internal server error'}), 500


# ==================== MAIN ====================

if __name__ == '__main__':
    with app.app_context():
        db.create_all()
        init_sample_products()
    app.run(debug=True, host='127.0.0.1', port=5000)
